// Generated by CoffeeScript 1.6.3
(function() {
  var authCallback, authorize, pocket, qs, redirect, request;

  qs = require('qs');

  request = require('request');

  pocket = require('./api');

  redirect = function(res, url) {
    res.writeHead(302, {
      Location: url
    });
    return res.end();
  };

  authorize = function(req, res, next) {
    var authorizeUrl, requestTokenUrl;
    requestTokenUrl = pocket.getRequestTokenUrl();
    authorizeUrl = pocket.getAuthorizeUrl();
    return request.post({
      headers: {
        'content-type': 'application/x-www-form-urlencoded'
      },
      url: requestTokenUrl,
      body: qs.stringify({
        consumer_key: pocket.consumer_key,
        redirect_uri: pocket.redirect_uri
      })
    }, function(err, resp, result) {
      var e, ri;
      try {
        result = qs.parse(result);
        ri = encodeURIComponent("" + pocket.redirect_uri + "?code=" + result.code);
        return res.redirect("" + authorizeUrl + "?request_token=" + result.code + "&redirect_uri=" + ri);
      } catch (_error) {
        e = _error;
        return next(e);
      }
    });
  };

  authCallback = function(req, res, next, options) {
    return request.post({
      headers: {
        'content-type': 'application/x-www-form-urlencoded'
      },
      url: pocket.getAccessTokenUrl(),
      body: qs.stringify({
        consumer_key: pocket.consumer_key,
        code: req.query.code
      })
    }, function(err, resp, result) {
      var e, ret;
      try {
        ret = qs.parse(result);
        ret.refer = options.refer;
      } catch (_error) {
        e = _error;
        ret = {};
      }
      return options.afterSuccess(ret, req, res, next);
    });
  };

  module.exports = function(options) {
    if (options == null) {
      options = {};
    }
    options.authorizeUri || (options.authorizeUri = '/pocket/authorize');
    options.pocketCallback || (options.pocketCallback = '/pocket/callback');
    options.refer || (options.refer = 'pocket');
    options.afterSuccess || (options.afterSuccess = function(ret, req, res) {
      return redirect(res, req.headers.referer || '/');
    });
    return function(req, res, next) {
      switch (req.path) {
        case options.authorizeUri:
          return authorize(req, res, next);
        case options.pocketCallback:
          return authCallback(req, res, next, options);
        default:
          return next();
      }
    };
  };

}).call(this);
